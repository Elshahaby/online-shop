<%- include('./parts/header.ejs')%>
<%- include('./parts/nav.ejs')%>

<link rel="stylesheet" href="/css/tablePagesStyles.css">
<script src="/js/confirmDeletion.js" defer></script>
<script src="https://www.paypal.com/sdk/js?client-id=AUQrLxOt5gP4F_4xMplLBE1Ep5EyW1CTk6AzGE5BaKBVGJXoMdkKWdBAp23vq2l8FMxuVEQECybOgC6o&currency=USD"></script>

<% if(typeof cart !== "undefined" && cart.length > 0) { %>
    <div class="container mt-4">
        <h2 class="page-title text-center">My Cart</h2>
    </div>
    
    <br>
    
    <table class="table table-striped table-bordered table-hover table-dark">
        <thead>
            <tr>
                <th scope="col">Image</th>
                <th scope="col">Title</th>
                <th scope="col">Price</th>
                <th scope="col">Quantity</th>
                <th scope="col">Actions</th>
                <th scope="col">Subtotal</th>
            </tr>
        </thead>
        <tbody>
            <% let total = 0; %>
            <% cart.forEach( product => { %>
                <% let sub = Number(parseFloat(product.quantity * product.price).toFixed(2)); %>
                <% total += +sub %>
                <tr>
                    <td class="align-middle">
                        <img src="<%= product.image %>" alt="Product Image" class="product-image">
                    </td>
                    <td class="align-middle"><%= product.title  %></td>
                    <td class="align-middle">$<%= parseFloat(product.price).toFixed(2) %></td>
                    <td class="align-middle"><%= product.quantity %></td>
                    <td class="align-middle">
                        <a href="/cart/update/<%= product.slug %>?action=add" class="btn btn-sm btn-success">‚ûï</a>
                        <a href="/cart/update/<%= product.slug %>?action=remove" class="btn btn-sm btn-warning">‚ûñ</a>
                        <a href="/cart/update/<%= product.slug %>?action=clear" class="btn btn-sm btn-danger">üóëÔ∏è</a>
                    </td>
                    <td class="align-middle ps">$<%= sub %></td>
                </tr>
            <% }) %>
        </tbody>
    </table>

    <p class="total-price">Total: $<%= parseFloat(total).toFixed(2) %></p>
    
    <a href="/cart/clear" class="btn btn-danger delete-btn">Clear Cart</a>
    <a class="btn btn-primary buynow" id="buyNowBtn">Buy now</a>
    
    <!-- Buy Now and PayPal Button -->
    <div class="text-center mt-3">
        
        <!-- PayPal Button -->
        <div id="paypal-button-container" class="pp"></div>
    </div>

    <script>
    document.getElementById("buyNowBtn").addEventListener("click", function(event) {
        document.getElementById("paypal-button-container").style.display = "block"; // Show PayPal button

        const cartItems = <%- JSON.stringify(cart) %>; // Convert cart to valid JSON

        document.getElementById("paypal-button-container").innerHTML = "";


        paypal.Buttons({
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: '<%= parseFloat(total).toFixed(2) %>', // Set total dynamically
                            currency_code: "USD",
                            breakdown: {
                                item_total: {
                                    currency_code: "USD",
                                    value: '<%= parseFloat(total).toFixed(2) %>' // Total of items
                                }
                            }
                        },
                        items: cartItems.map(product => ({
                            name: product.title,  // Product Name
                            quantity: product.quantity,
                            unit_amount: {
                                currency_code: "USD",
                                value: parseFloat(product.price).toFixed(2)
                            },
                        }))
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    console.log("Transaction details:", details);
                    
                    Swal.fire({
                        title: "Payment Successful!",
                        text: "Thank you, " + details.payer.name.given_name + "! Your payment of $" + details.purchase_units[0].amount.value + " was successful.",
                        icon: "success",
                        confirmButtonText: "OK"
                    }).then(() => {
                        fetch("/cart/buynow", { 
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(details)    
                        })
                        .then(() => window.location.href = "/"); 
                    });
                });
            },
            onError: function(err) {
                console.error('PayPal Error:', err);
                Swal.fire({
                    title: "Payment Failed",
                    text: "Something went wrong. Please try again later.",
                    icon: "error",
                    confirmButtonText: "OK"
                });
            }
        }).render('#paypal-button-container');
    })
  </script>
    

<% } else { %>
    <h3 class="text-center page-title text-primary">Your Cart Is Empty</h3>
<% } %>

<!-- Authentication Info -->
<div class="row mt-4">
    <div class="col-12 text-center auth-links">
        <% if (user) { %>
            <p>You are logged in. <a href="/auth/logout">Logout</a></p>
        <% } else { %>
            <p>You are not logged in. <a href="/auth/login">Login</a> or <a href="/auth/signup">Register</a>.</p>
        <% } %>
    </div>
</div>


<%- include('./parts/footer.ejs')%>
